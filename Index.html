<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RUC Details</title>
    <link rel="stylesheet" href__="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href__="style.css">
</head>
<body>
    <div id="loading">
        <div class="spinner-container">
            <div class="spinner"></div>
            <p>Loading vehicle RUC data...</p>
        </div>
    </div>
    
    <div id="error-message" class="alert alert-danger" style="display:none;"></div>

    <div id="rucAddin" class="panel panel-default" style="display:none;">
        <div class="panel-heading">
            <h3 class="panel-title">Vehicle RUC Details</h3>
        </div>
        <div class="panel-body">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Vehicle</th>
                        <th>Last RUC Log Date</th>
                        <th>Odometer (km)</th>
                        <th>Distance (km)</th>
                        <th>RUC Label Number</th>
                    </tr>
                </thead>
                <tbody id="ruc-table-body"></tbody>
            </table>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        geotab.addin.ruc = function (api, state) {
            var rucTableBody, loadingDiv, rucAddinDiv, errorDiv;

            // Helper to hide loading and show content
            function showContent() {
                loadingDiv.style.display = "none";
                rucAddinDiv.style.display = "block";
            }
            
            function showError(message) {
                loadingDiv.style.display = "none";
                errorDiv.textContent = message;
                errorDiv.style.display = "block";
            }

            // More robust row creation
            function createRow(data) {
                var row = document.createElement("tr");
                row.innerHTML = "<td>" + (data.vehicleName || "N/A") + "</td>" +
                    "<td>" + (data.dateTime || "-") + "</td>" +
                    "<td>" + (data.odometer || "-") + "</td>" +
                    "<td>" + (data.distance || "-") + "</td>" +
                    "<td>" + (data.rucLabel || "-") + "</td>";
                rucTableBody.appendChild(row);
            }

            // Using modern async/await for clearer, more reliable code
            async function fetchData() {
                try {
                    // 1. Get all devices
                    console.log("Fetching devices...");
                    var devices = await api.call("Get", {
                        typeName: "Device",
                        search: { groups: state.getGroups() }
                    });
                    console.log("Found " + devices.length + " devices.");

                    if (devices.length === 0) {
                        createRow({ vehicleName: "No vehicles found in your groups." });
                        showContent();
                        return;
                    }

                    // 2. Find the RUC diagnostic dynamically
                    console.log("Searching for RUC diagnostic...");
                    var allDiagnostics = await api.call("Get", { typeName: "Diagnostic" });
                    var rucDiagnostic = allDiagnostics.find(function(d) {
                        return d.name && d.name.toLowerCase().includes("ruc");
                    });

                    if (!rucDiagnostic) {
                        console.error("No RUC diagnostic found.");
                        showError("Configuration Error: No diagnostic containing 'RUC' could be found on this database.");
                        return;
                    }
                    console.log("Found RUC Diagnostic:", rucDiagnostic);

                    // 3. Get all relevant logs for ALL devices in ONE efficient call
                    console.log("Fetching DutyStatusLogs for all devices...");
                    var deviceIds = devices.map(function(d) { return d.id; });
                    var statusLogs = await api.call("Get", {
                        typeName: "DutyStatusLog",
                        search: {
                            deviceSearch: { id: deviceIds },
                            diagnosticSearch: { id: rucDiagnostic.id }
                        }
                    });
                    console.log("Found " + statusLogs.length + " logs.");
                    
                    // 4. Process logs to find the latest for each vehicle
                    var latestLogs = {};
                    statusLogs.forEach(function(log) {
                        var id = log.device.id;
                        if (!latestLogs[id] || new Date(log.dateTime) > new Date(latestLogs[id].dateTime)) {
                            latestLogs[id] = log;
                        }
                    });
                    
                    // 5. Display the data
                    devices.forEach(function(device) {
                        var log = latestLogs[device.id];
                        if (log) {
                            createRow({
                                vehicleName: device.name,
                                dateTime: new Date(log.dateTime).toLocaleString(),
                                odometer: log.odometer ? Math.round(log.odometer / 1000) + " km" : "N/A",
                                distance: log.data ? log.data + " km" : "N/A",
                                rucLabel: log.data || "N/A"
                            });
                        } else {
                            createRow({ vehicleName: device.name, dateTime: "No recent RUC log found." });
                        }
                    });
                    
                    showContent();

                } catch (err) {
                    console.error("An error occurred:", err);
                    showError("An error occurred while loading data: " + err.message);
                }
            }

            return {
                initialize: function (api, state, callback) {
                    rucTableBody = document.getElementById("ruc-table-body");
                    loadingDiv = document.getElementById("loading");
                    rucAddinDiv = document.getElementById("rucAddin");
                    errorDiv = document.getElementById("error-message");
                    
                    fetchData(); // Start the data loading process

                    if (callback) {
                        callback();
                    }
                },
                focus: function (api, state) {},
                blur: function () {}
            };
        };
    </script>
</body>
</html>